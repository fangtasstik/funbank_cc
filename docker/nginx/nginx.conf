# Nginx Configuration for Funbank Banking System
# Reverse proxy and load balancer for microservices

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logging configuration
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Upstream definitions for load balancing (ready for future scaling)
    upstream funbank_adminer {
        server adminer:8080;
    }

    upstream funbank_mongo_express {
        server mongo-express:8081;
    }

    upstream funbank_redis_commander {
        server redis-commander:8081;
    }

    # Main server block
    server {
        listen 80;
        server_name localhost funbank.local;

        # Main landing page
        location / {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Funbank Development Environment</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .services { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .service { background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center; }
        .service a { color: #2980b9; text-decoration: none; font-weight: bold; }
        .service a:hover { color: #1abc9c; }
        .status { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Funbank Development Environment</h1>
        <p>Welcome to the Funbank microservices development environment. All services are running and accessible.</p>
        
        <div class="services">
            <div class="service">
                <h3>MySQL Admin</h3>
                <p><a href="/mysql/">Adminer Interface</a></p>
                <p class="status">✓ Running</p>
            </div>
            <div class="service">
                <h3>MongoDB Admin</h3>
                <p><a href="/mongo/">Mongo Express</a></p>
                <p class="status">✓ Running</p>
            </div>
            <div class="service">
                <h3>Redis Admin</h3>
                <p><a href="/redis/">Redis Commander</a></p>
                <p class="status">✓ Running</p>
            </div>
        </div>
        
        <hr style="margin: 30px 0;">
        <p><strong>Phase 1 Complete:</strong> Database infrastructure and admin tools are ready for development.</p>
        <p><strong>Next Phase:</strong> Microservices core (Config Server, Service Registry, API Gateway)</p>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Database administration interfaces
        location /mysql/ {
            proxy_pass http://funbank_adminer/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle redirects properly
            proxy_redirect off;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Mongo Express static assets - Must come before /mongo/
        location ~ ^/(public)/ {
            # rewrite ^/mongo/(.*)$ /$1 break;
            proxy_pass http://funbank_mongo_express;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Pass through authentication for protected assets
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            proxy_pass_header WWW-Authenticate;
            
            # Cache static assets
            expires 1h;
            add_header Cache-Control "public, max-age=3600";
        }

        location /mongo/ {
            proxy_pass http://funbank_mongo_express/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle authentication
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            proxy_pass_header WWW-Authenticate;
        }

        # Redis Commander static assets - Must come before /redis/
        location ~ ^/redis/(bootstrap|css|js|jstree|json-viewer|images|scripts|clipboard|dateformat)/ {
            rewrite ^/redis/(.*)$ /$1 break;
            proxy_pass http://funbank_redis_commander;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Pass through authentication for protected assets
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            
            # Cache static assets
            expires 1h;
            add_header Cache-Control "public, max-age=3600";
        }

        # Redis Commander API routes
        location ~ ^/redis/api/ {
            rewrite ^/redis/(.*)$ /$1 break;
            proxy_pass http://funbank_redis_commander;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Handle authentication for API calls
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            proxy_pass_header WWW-Authenticate;
        }

        location /redis/ {
            proxy_pass http://funbank_redis_commander/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle authentication
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 '{"status":"healthy","timestamp":"$time_iso8601","services":{"nginx":"running"}}';
            add_header Content-Type application/json;
        }

        # Future API routes (ready for microservices)
        location /api/ {
            return 503 '{"error":"API Gateway not yet implemented","phase":"Phase 2 - Coming Soon"}';
            add_header Content-Type application/json;
        }

        # Static assets and resources
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Direct access server (for backward compatibility)
    server {
        listen 8000;
        server_name localhost;

        location /adminer {
            proxy_pass http://funbank_adminer;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /mongo-express {
            proxy_pass http://funbank_mongo_express;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /redis-commander {
            proxy_pass http://funbank_redis_commander;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}